{% extends 'base.html' %}
{% load static %}

{% block title %}Delivery Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>
        <i class="fas fa-tachometer-alt"></i> Delivery Dashboard
    </h2>
    <div>
        <button class="btn btn-outline-primary" onclick="location.reload()">
            <i class="fas fa-sync-alt"></i> Refresh
        </button>
    </div>
</div>

<!-- Statistics Cards -->
<div class="row mb-4">
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ pending_deliveries }}</h3>
                        <p class="mb-0">Pending Deliveries</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-clock fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ in_transit_deliveries }}</h3>
                        <p class="mb-0">In Transit</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-truck fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ completed_deliveries }}</h3>
                        <p class="mb-0">Completed</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-3 col-md-6 mb-4">
        <div class="card dashboard-card">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h3>{{ pending_deliveries|add:in_transit_deliveries|add:completed_deliveries }}</h3>
                        <p class="mb-0">Total Deliveries</p>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-chart-line fa-2x opacity-75"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt"></i> Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-2">
                        <a href="#" class="btn btn-primary w-100">
                            <i class="fas fa-plus"></i> Create Delivery
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="#" class="btn btn-success w-100">
                            <i class="fas fa-users"></i> Delivery Partners
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="#" class="btn btn-info w-100">
                            <i class="fas fa-chart-bar"></i> Reports
                        </a>
                    </div>
                    <div class="col-md-3 mb-2">
                        <a href="#" class="btn btn-warning w-100">
                            <i class="fas fa-cog"></i> Settings
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Deliveries Table -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list"></i> Recent Deliveries
                </h5>
                <a href="#" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-eye"></i> View All
                </a>
            </div>
            <div class="card-body">
                {% if recent_deliveries %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Order ID</th>
                                <th>Tracking ID</th>
                                <th>Customer</th>
                                <th>Delivery Partner</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for delivery in recent_deliveries %}
                            <tr>
                                <td>
                                    <strong>#{{ delivery.order.order_id }}</strong>
                                </td>
                                <td>
                                    <span class="font-monospace">{{ delivery.tracking_id }}</span>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary rounded-circle d-flex align-items-center justify-content-center me-2">
                                            <span class="text-white small">{{ delivery.order.user.first_name|first }}{{ delivery.order.user.last_name|first }}</span>
                                        </div>
                                        <div>
                                            <div>{{ delivery.order.user.get_full_name|default:delivery.order.user.username }}</div>
                                            <small class="text-muted">{{ delivery.order.user.email }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    {% if delivery.delivery_partner %}
                                        <div>
                                            <strong>{{ delivery.delivery_partner.name }}</strong>
                                            <br><small class="text-muted">{{ delivery.delivery_partner.phone }}</small>
                                        </div>
                                    {% else %}
                                        <span class="text-muted">Not assigned</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <span class="status-badge status-{{ delivery.status }}">
                                        {{ delivery.get_status_display }}
                                    </span>
                                </td>
                                <td>
                                    <div>{{ delivery.created_at|date:"M d, Y" }}</div>
                                    <small class="text-muted">{{ delivery.created_at|time:"g:i A" }}</small>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        <a href="{% url 'delivery:track_delivery' delivery.order.order_id %}" 
                                           class="btn btn-outline-primary" title="View Details">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-success" title="Update Status">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <a href="#" class="btn btn-outline-info" title="Contact Customer">
                                            <i class="fas fa-phone"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No deliveries found</h5>
                    <p class="text-muted">Recent deliveries will appear here once orders are created.</p>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Status Filter Cards -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-filter"></i> Filter by Status
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 mb-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h4 class="text-warning">{{ pending_deliveries }}</h4>
                                <p class="mb-2">Assigned</p>
                                <a href="?status=assigned" class="btn btn-sm btn-outline-warning">View All</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-info">
                            <div class="card-body text-center">
                                <h4 class="text-info">{{ in_transit_deliveries }}</h4>
                                <p class="mb-2">In Progress</p>
                                <a href="?status=in_transit" class="btn btn-sm btn-outline-info">View All</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h4 class="text-success">{{ completed_deliveries }}</h4>
                                <p class="mb-2">Completed</p>
                                <a href="?status=delivered" class="btn btn-sm btn-outline-success">View All</a>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h4 class="text-danger">0</h4>
                                <p class="mb-2">Failed</p>
                                <a href="?status=failed" class="btn btn-sm btn-outline-danger">View All</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.avatar-sm {
    width: 32px;
    height: 32px;
    font-size: 12px;
}

.dashboard-card {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
}

.dashboard-card:nth-child(2) .card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.dashboard-card:nth-child(3) .card {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
}

.dashboard-card:nth-child(4) .card {
    background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
}

.table th {
    border-top: none;
    font-weight: 600;
    color: #495057;
}

.table td {
    vertical-align: middle;
}

.btn-group-sm > .btn {
    padding: 0.25rem 0.4rem;
}

@media (max-width: 768px) {
    .table-responsive {
        font-size: 0.875rem;
    }
    
    .btn-group {
        flex-direction: column;
    }
    
    .btn-group .btn {
        border-radius: 0.25rem !important;
        margin-bottom: 2px;
    }
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh dashboard every 2 minutes
setInterval(function() {
    location.reload();
}, 120000);

// Add tooltips to action buttons
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

// Status filter functionality
function filterByStatus(status) {
    const url = new URL(window.location);
    url.searchParams.set('status', status);
    window.location.href = url.toString();
}

// Clear filters
function clearFilters() {
    const url = new URL(window.location);
    url.searchParams.delete('status');
    window.location.href = url.toString();
}
</script>
{% endblock %}