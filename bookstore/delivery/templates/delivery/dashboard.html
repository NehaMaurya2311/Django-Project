{% extends 'delivery/base.html' %}
{% load static %}

{% block title %}Delivery Dashboard{% endblock %}

{% block extra_css %}
<style>
:root {
    --primary-gradient: linear-gradient(135deg, #ff7b7b 0%, #ff9a56 100%);
    --secondary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --success-gradient: linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%);
    --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    --coral-gradient: linear-gradient(135deg, #ff6b6b 0%, #ffa726 100%);
    --peach-gradient: linear-gradient(135deg, #ffb347 0%, #ffcc33 100%);
}

body {
    background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 50%, #ff8a80 100%);
    min-height: 100vh;
}

.dashboard-header {
    background: var(--primary-gradient);
    color: white;
    padding: 2rem 0;
    margin-bottom: 2rem;
    border-radius: 0 0 30px 30px;
    box-shadow: 0 8px 32px rgba(255, 123, 123, 0.3);
}

.dashboard-header h2 {
    font-weight: 700;
    text-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.stats-card {
    background: white;
    border-radius: 20px;
    padding: 2rem;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: none;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
}

.stats-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: var(--primary-gradient);
}

.stats-card:hover {
    transform: translateY(-8px);
    box-shadow: 0 20px 40px rgba(0,0,0,0.15);
}

.stats-number {
    font-size: 3rem;
    font-weight: 800;
    background: var(--primary-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 0.5rem;
}

.stats-label {
    color: #666;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-size: 0.9rem;
}

.stats-icon {
    width: 60px;
    height: 60px;
    border-radius: 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.8rem;
    color: white;
}

.stats-icon.pending {
    background: var(--warning-gradient);
}

.stats-icon.transit {
    background: var(--info-gradient);
}

.stats-icon.completed {
    background: var(--success-gradient);
}

.stats-icon.total {
    background: var(--secondary-gradient);
}

.quick-actions-card {
    background: white;
    border-radius: 20px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

.quick-actions-card .card-header {
    background: var(--coral-gradient);
    color: white;
    border: none;
    padding: 1.5rem;
}

.action-btn {
    background: white;
    border: 2px solid transparent;
    border-radius: 15px;
    padding: 1rem;
    text-decoration: none;
    color: #333;
    transition: all 0.3s ease;
    display: block;
    text-align: center;
    font-weight: 600;
}

.action-btn:hover {
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.action-btn.create:hover {
    background: var(--primary-gradient);
    border-color: #ff7b7b;
}

.action-btn.partners:hover {
    background: var(--success-gradient);
    border-color: #56ab2f;
}

.action-btn.reports:hover {
    background: var(--info-gradient);
    border-color: #4facfe;
}

.action-btn.settings:hover {
    background: var(--warning-gradient);
    border-color: #f093fb;
}

.recent-deliveries-card {
    background: white;
    border-radius: 20px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    overflow: hidden;
}

.recent-deliveries-card .card-header {
    background: var(--peach-gradient);
    color: white;
    border: none;
    padding: 1.5rem;
}

.delivery-table {
    border: none;
}

.delivery-table th {
    border: none;
    color: #666;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.8rem;
    letter-spacing: 1px;
    padding: 1rem;
    background-color: #f8f9fa;
}

.delivery-table td {
    border: none;
    padding: 1rem;
    vertical-align: middle;
    border-bottom: 1px solid #eee;
}

.delivery-table tr:hover {
    background-color: #fff8f3;
}

.customer-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--primary-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-weight: 700;
    font-size: 0.9rem;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 25px;
    font-weight: 700;
    text-transform: uppercase;
    font-size: 0.7rem;
    letter-spacing: 1px;
}

.status-assigned { 
    background: linear-gradient(45deg, #ffeaa7, #fab1a0);
    color: #2d3436;
}

.status-picked_up { 
    background: linear-gradient(45deg, #74b9ff, #0984e3);
    color: white;
}

.status-in_transit { 
    background: linear-gradient(45deg, #a29bfe, #6c5ce7);
    color: white;
}

.status-out_for_delivery { 
    background: linear-gradient(45deg, #fd79a8, #e84393);
    color: white;
}

.status-delivered { 
    background: linear-gradient(45deg, #00b894, #00cec9);
    color: white;
}

.status-failed { 
    background: linear-gradient(45deg, #e17055, #d63031);
    color: white;
}

.status-returned { 
    background: linear-gradient(45deg, #636e72, #2d3436);
    color: white;
}

.action-buttons .btn {
    border: none;
    border-radius: 10px;
    padding: 0.5rem 0.8rem;
    margin: 0 2px;
    transition: all 0.3s ease;
}

.action-buttons .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.btn-view {
    background: var(--info-gradient);
    color: white;
}

.btn-edit {
    background: var(--success-gradient);
    color: white;
}

.btn-contact {
    background: var(--warning-gradient);
    color: white;
}

.filter-cards-section {
    margin-top: 2rem;
}

.filter-card {
    background: white;
    border-radius: 15px;
    border: none;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
    transition: all 0.3s ease;
    overflow: hidden;
}

.filter-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.12);
}

.filter-number {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 0.5rem;
}

.filter-card.assigned .filter-number {
    background: var(--warning-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.filter-card.progress .filter-number {
    background: var(--info-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.filter-card.completed .filter-number {
    background: var(--success-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.filter-card.failed .filter-number {
    background: linear-gradient(45deg, #e17055, #d63031);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
}

.filter-btn {
    border: 2px solid;
    border-radius: 20px;
    padding: 0.4rem 1.2rem;
    font-weight: 600;
    text-decoration: none;
    transition: all 0.3s ease;
}

.filter-btn.assigned {
    color: #fab1a0;
    border-color: #fab1a0;
}

.filter-btn.assigned:hover {
    background: var(--warning-gradient);
    color: white;
}

.filter-btn.progress {
    color: #74b9ff;
    border-color: #74b9ff;
}

.filter-btn.progress:hover {
    background: var(--info-gradient);
    color: white;
}

.filter-btn.completed {
    color: #00b894;
    border-color: #00b894;
}

.filter-btn.completed:hover {
    background: var(--success-gradient);
    color: white;
}

.filter-btn.failed {
    color: #e17055;
    border-color: #e17055;
}

.filter-btn.failed:hover {
    background: linear-gradient(45deg, #e17055, #d63031);
    color: white;
}

.empty-state {
    padding: 3rem;
    text-align: center;
    color: #666;
}

.empty-state i {
    font-size: 4rem;
    margin-bottom: 1rem;
    color: #ddd;
}

.refresh-btn {
    background: var(--secondary-gradient);
    border: none;
    border-radius: 15px;
    color: white;
    padding: 0.7rem 1.5rem;
    font-weight: 600;
    transition: all 0.3s ease;
}

.refresh-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    color: white;
}

@media (max-width: 768px) {
    .stats-number {
        font-size: 2rem;
    }
    
    .stats-icon {
        width: 50px;
        height: 50px;
        font-size: 1.5rem;
    }
    
    .delivery-table {
        font-size: 0.9rem;
    }
    
    .action-buttons {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }
}

/* Animations */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.stats-card, .quick-actions-card, .recent-deliveries-card, .filter-card {
    animation: fadeInUp 0.6s ease-out;
    animation-fill-mode: both;
}

.stats-card:nth-child(1) { animation-delay: 0.1s; }
.stats-card:nth-child(2) { animation-delay: 0.2s; }
.stats-card:nth-child(3) { animation-delay: 0.3s; }
.stats-card:nth-child(4) { animation-delay: 0.4s; }

/* Toast notification styles */
@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.toast-notification {
    animation: slideInRight 0.3s ease-out;
}
</style>
{% endblock %}

{% block content %}
<!-- Dashboard Header -->
<div class="dashboard-header">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h2 class="mb-0">
                <i class="fas fa-tachometer-alt me-3"></i>Delivery Dashboard
            </h2>
            <button class="btn refresh-btn" onclick="location.reload()">
                <i class="fas fa-sync-alt me-2"></i>Refresh
            </button>
        </div>
    </div>
</div>

<div class="container">
    <!-- Statistics Cards -->
    <div class="row mb-5">
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ pending_deliveries }}</div>
                        <div class="stats-label">Pending</div>
                    </div>
                    <div class="stats-icon pending">
                        <i class="fas fa-clock"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ in_transit_deliveries }}</div>
                        <div class="stats-label">In Transit</div>
                    </div>
                    <div class="stats-icon transit">
                        <i class="fas fa-truck"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ completed_deliveries }}</div>
                        <div class="stats-label">Completed</div>
                    </div>
                    <div class="stats-icon completed">
                        <i class="fas fa-check-circle"></i>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-3 col-md-6 mb-4">
            <div class="card stats-card">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="stats-number">{{ pending_deliveries|add:in_transit_deliveries|add:completed_deliveries }}</div>
                        <div class="stats-label">Total</div>
                    </div>
                    <div class="stats-icon total">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card quick-actions-card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <a href="{% url 'delivery:create_delivery' %}" class="action-btn create">
                                <i class="fas fa-plus fa-2x mb-2"></i>
                                <div>Create Delivery</div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'delivery:partner_list' %}" class="action-btn partners">
                                <i class="fas fa-users fa-2x mb-2"></i>
                                <div>Delivery Partners</div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'delivery:delivery_list' %}" class="action-btn reports">
                                <i class="fas fa-chart-bar fa-2x mb-2"></i>
                                <div>All Deliveries</div>
                            </a>
                        </div>
                        <div class="col-md-3">
                            <a href="{% url 'delivery:bulk_assign_partners' %}" class="action-btn settings">
                                <i class="fas fa-cog fa-2x mb-2"></i>
                                <div>Bulk Assign</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Deliveries -->
    <div class="row mb-5">
        <div class="col-12">
            <div class="card recent-deliveries-card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>Recent Deliveries
                    </h5>
                    <a href="{% url 'delivery:delivery_list' %}" class="btn btn-light btn-sm">
                        <i class="fas fa-eye me-1"></i>View All
                    </a>
                </div>
                <div class="card-body p-0">
                    {% if recent_deliveries %}
                    <div class="table-responsive">
                        <table class="table delivery-table mb-0">
                            <thead>
                                <tr>
                                    <th>Order</th>
                                    <th>Customer</th>
                                    <th>Partner</th>
                                    <th>Status</th>
                                    <th>Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for delivery in recent_deliveries %}
                                <tr>
                                    <td>
                                        <div>
                                            <strong>#{{ delivery.order.order_id }}</strong>
                                            <br>
                                            <small class="text-muted font-monospace" 
                                                   style="cursor: pointer;" 
                                                   onclick="copyTrackingId('{{ delivery.tracking_id }}')" 
                                                   title="Click to copy tracking ID">{{ delivery.tracking_id }}</small>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div class="customer-avatar me-3">
                                                {{ delivery.order.user.first_name|first }}{{ delivery.order.user.last_name|first }}
                                            </div>
                                            <div>
                                                <div class="fw-bold">{{ delivery.order.user.get_full_name|default:delivery.order.user.username }}</div>
                                                <small class="text-muted">{{ delivery.order.user.email }}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        {% if delivery.delivery_partner %}
                                            <div>
                                                <strong>{{ delivery.delivery_partner.name }}</strong>
                                                <br><small class="text-muted">{{ delivery.delivery_partner.phone }}</small>
                                            </div>
                                        {% else %}
                                            <div class="text-muted">
                                                <i class="fas fa-user-times"></i> Not assigned
                                                <br><small>Auto-assignment failed</small>
                                            </div>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="status-badge status-{{ delivery.status }}">
                                            {{ delivery.get_status_display }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="fw-bold">{{ delivery.created_at|date:"M d" }}</div>
                                        <small class="text-muted">{{ delivery.created_at|time:"g:i A" }}</small>
                                    </td>
                                    <td>
                                        <div class="action-buttons">
                                            <a href="{% url 'delivery:track_delivery' delivery.order.order_id %}" 
                                               class="btn btn-sm btn-view" title="View Details">
                                                <i class="fas fa-eye"></i>
                                            </a>
                                            <a href="{% url 'delivery:update_status' delivery.id %}" class="btn btn-sm btn-edit" title="Update Status">
                                                <i class="fas fa-edit"></i>
                                            </a>
                                            <a href="tel:{{ delivery.order.user.phone }}" 
                                               class="btn btn-sm btn-contact" title="Contact">
                                                <i class="fas fa-phone"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="empty-state">
                        <i class="fas fa-inbox"></i>
                        <h5 class="mt-3">No deliveries found</h5>
                        <p class="text-muted">Recent deliveries will appear here once orders are created.</p>
                        <a href="{% url 'delivery:create_delivery' %}" class="btn refresh-btn">
                            <i class="fas fa-plus me-2"></i>Create First Delivery
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Status Filter Cards -->
    <div class="filter-cards-section">
        <div class="row">
            <div class="col-12">
                <h4 class="mb-4" style="color: #666; font-weight: 700;">
                    <i class="fas fa-filter me-2"></i>Filter by Status
                </h4>
            </div>
        </div>
        <div class="row">
            <div class="col-md-3 mb-4">
                <div class="card filter-card assigned">
                    <div class="card-body text-center">
                        <div class="filter-number">{{ pending_deliveries }}</div>
                        <p class="mb-3 text-muted fw-bold">Assigned Orders</p>
                        <a href="{% url 'delivery:delivery_list' %}?status=assigned" class="filter-btn assigned">View All</a>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card filter-card progress">
                    <div class="card-body text-center">
                        <div class="filter-number">{{ in_transit_deliveries }}</div>
                        <p class="mb-3 text-muted fw-bold">In Progress</p>
                        <a href="{% url 'delivery:delivery_list' %}?status=in_transit" class="filter-btn progress">View All</a>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card filter-card completed">
                    <div class="card-body text-center">
                        <div class="filter-number">{{ completed_deliveries }}</div>
                        <p class="mb-3 text-muted fw-bold">Completed</p>
                        <a href="{% url 'delivery:delivery_list' %}?status=delivered" class="filter-btn completed">View All</a>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-4">
                <div class="card filter-card failed">
                    <div class="card-body text-center">
                        <div class="filter-number">0</div>
                        <p class="mb-3 text-muted fw-bold">Failed</p>
                        <a href="{% url 'delivery:delivery_list' %}?status=failed" class="filter-btn failed">View All</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Auto-refresh dashboard every 2 minutes
let autoRefreshInterval = setInterval(function() {
    // Only refresh if user is still on the page
    if (!document.hidden) {
        location.reload();
    }
}, 120000);

// Pause auto-refresh when user leaves the page
document.addEventListener('visibilitychange', function() {
    if (document.hidden) {
        clearInterval(autoRefreshInterval);
    } else {
        autoRefreshInterval = setInterval(function() {
            location.reload();
        }, 120000);
    }
});

// Add tooltips to action buttons
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Bootstrap tooltips if available
    if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[title]'));
        var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl, {
                placement: 'top',
                trigger: 'hover'
            });
        });
    }

    // Add loading animation to buttons
    document.querySelectorAll('.action-btn, .filter-btn').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            if (this.href && this.href !== '#') {
                this.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
            }
        });
    });
});

// Status filter functionality with smooth transitions
function filterByStatus(status) {
    // Add loading state
    event.target.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Loading...';
    
    const url = new URL(window.location);
    url.searchParams.set('status', status);
    
    // Add smooth transition
    document.body.style.transition = 'opacity 0.3s ease';
    document.body.style.opacity = '0.7';
    
    setTimeout(() => {
        window.location.href = url.toString();
    }, 300);
}

// Clear filters
function clearFilters() {
    const url = new URL(window.location);
    url.searchParams.delete('status');
    
    document.body.style.transition = 'opacity 0.3s ease';
    document.body.style.opacity = '0.7';
    
    setTimeout(() => {
        window.location.href = url.toString();
    }, 300);
}

// Add smooth hover effects for cards
document.querySelectorAll('.stats-card, .filter-card').forEach(card => {
    card.addEventListener('mouseenter', function() {
        this.style.transform = 'translateY(-8px) scale(1.02)';
    });
    
    card.addEventListener('mouseleave', function() {
        this.style.transform = 'translateY(0) scale(1)';
    });
});

// Add click animations
document.querySelectorAll('.btn').forEach(btn => {
    btn.addEventListener('click', function() {
        this.style.transform = 'scale(0.95)';
        setTimeout(() => {
            this.style.transform = 'scale(1)';
        }, 150);
    });
});

// Copy tracking ID functionality
function copyTrackingId(trackingId) {
    if (navigator.clipboard) {
        navigator.clipboard.writeText(trackingId).then(function() {
            showToast('Tracking ID copied to clipboard!', 'success');
        }).catch(function() {
            // Fallback for older browsers
            fallbackCopyTextToClipboard(trackingId);
        });
    } else {
        // Fallback for older browsers
        fallbackCopyTextToClipboard(trackingId);
    }
}

// Fallback copy function for older browsers
function fallbackCopyTextToClipboard(text) {
    var textArea = document.createElement("textarea");
    textArea.value = text;
    
    // Avoid scrolling to bottom
    textArea.style.top = "0";
    textArea.style.left = "0";
    textArea.style.position = "fixed";

    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();

    try {
        var successful = document.execCommand('copy');
        if (successful) {
            showToast('Tracking ID copied to clipboard!', 'success');
        } else {
            showToast('Failed to copy tracking ID', 'error');
        }
    } catch (err) {
        showToast('Failed to copy tracking ID', 'error');
    }

    document.body.removeChild(textArea);
}

// Toast notification system
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} toast-notification`;
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        padding: 1rem 1.5rem;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        animation: slideInRight 0.3s ease-out;
    `;
    toast.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            <span>${message}</span>
            <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.style.animation = 'slideOutRight 0.3s ease-out';
            setTimeout(() => {
                if (toast.parentElement) {
                    document.body.removeChild(toast);
                }
            }, 300);
        }
    }, 3000);
}

// Enhanced refresh functionality
function refreshDashboard() {
    const refreshBtn = document.querySelector('.refresh-btn');
    const originalContent = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    // Add visual feedback
    document.body.style.transition = 'opacity 0.3s ease';
    document.body.style.opacity = '0.8';
    
    setTimeout(() => {
        location.reload();
    }, 500);
}

// Update refresh button click handler
document.addEventListener('DOMContentLoaded', function() {
    const refreshBtn = document.querySelector('.refresh-btn');
    if (refreshBtn) {
        refreshBtn.removeAttribute('onclick');
        refreshBtn.addEventListener('click', refreshDashboard);
    }
});

// Enhanced table interactions
document.addEventListener('DOMContentLoaded', function() {
    // Add row click functionality for better UX
    document.querySelectorAll('.delivery-table tbody tr').forEach(row => {
        row.addEventListener('click', function(e) {
            // Don't trigger if clicking on action buttons
            if (e.target.closest('.action-buttons')) return;
            
            // Add subtle selection effect
            document.querySelectorAll('.delivery-table tbody tr').forEach(r => r.classList.remove('table-active'));
            this.classList.add('table-active');
            
            // Optional: Show more details or navigate
            const orderId = this.querySelector('strong').textContent.replace('#', '');
            console.log('Selected order:', orderId);
        });
    });
});

// Performance optimization: Debounce hover effects
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Apply debounced hover effects
document.addEventListener('DOMContentLoaded', function() {
    const debouncedHover = debounce((element, isEntering) => {
        if (isEntering) {
            element.style.transform = 'translateY(-8px) scale(1.02)';
        } else {
            element.style.transform = 'translateY(0) scale(1)';
        }
    }, 50);
    
    document.querySelectorAll('.stats-card, .filter-card').forEach(card => {
        card.addEventListener('mouseenter', () => debouncedHover(card, true));
        card.addEventListener('mouseleave', () => debouncedHover(card, false));
    });
});

// Keyboard accessibility improvements
document.addEventListener('DOMContentLoaded', function() {
    // Add keyboard navigation for filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                this.click();
            }
        });
    });
    
    // Add focus styles
    const style = document.createElement('style');
    style.textContent = `
        .filter-btn:focus,
        .action-btn:focus {
            outline: 2px solid #007bff;
            outline-offset: 2px;
        }
    `;
    document.head.appendChild(style);
});

// Error handling for network issues
window.addEventListener('online', function() {
    showToast('Connection restored', 'success');
});

window.addEventListener('offline', function() {
    showToast('Connection lost. Some features may not work properly.', 'error');
    clearInterval(autoRefreshInterval);
});

// Clean up intervals on page unload
window.addEventListener('beforeunload', function() {
    clearInterval(autoRefreshInterval);
});
</script>
{% endblock %}