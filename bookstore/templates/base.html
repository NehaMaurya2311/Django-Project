{% load static %}
{% load i18n %}
<!DOCTYPE html>
<html lang="{% get_current_language as LANGUAGE_CODE %}{{ LANGUAGE_CODE }}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    
    <!-- SEO Meta Tags -->
    <title>{% block title %}{% trans "BookStore - Your Literary Journey Starts Here" %}{% endblock %}</title>
    <meta name="description" content="{% block description %}{% trans 'Discover amazing books across all genres. Fiction, Non-Fiction, Comics, Children Books and more.' %}{% endblock %}">
    <meta name="keywords" content="{% block keywords %}books, bookstore, fiction, non-fiction, online books, literature{% endblock %}">
    
    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="{% static 'images/favicon.ico' %}">
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    
    <!-- Select2 for Enhanced Dropdowns -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet">
    
    <!-- Custom CSS Files -->
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/navbar.css' %}">
    <link rel="stylesheet" href="{% static 'css/footer.css' %}">
    <link rel="stylesheet" href="{% static 'css/responsive.css' %}">
    
    <!-- Page Specific CSS -->
    {% block extra_css %}{% endblock %}

</head>

<body class="{% block body_class %}{% endblock %}">
    <!-- Navigation -->
    {% include 'navbar.html' %}
    
    <!-- Messages Framework -->
    {% if messages %}
        <div class="messages-container">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        </div>
    {% endif %}
    
    <!-- Main Content -->
    <main id="main-content" class="main-content">
        {% block content %}
        {% endblock %}
    </main>
    
    <!-- Footer -->
    {% include 'footer.html' %}
    
    <!-- Back to Top Button -->
    <button id="backToTop" class="btn-back-to-top" title="{% trans 'Back to top' %}">
        <i class="fas fa-chevron-up"></i>
    </button>
    
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay d-none">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{% trans "Loading..." %}</span>
        </div>
    </div>
    
    <!-- Core JavaScript Libraries -->
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    
    <!-- Custom JavaScript -->
    <script src="{% static 'js/main.js' %}"></script>
    
    <!-- Page Specific JavaScript -->
    {% block extra_js %}{% endblock %}
    
   <!-- Add this to your base.html template, preferably in the <head> section or before closing </body> -->

        <!-- Global CSRF Token Setup -->
        <script>
        // Global CSRF token setup - Add this to your base.html
        window.csrfToken = '{{ csrf_token }}';

        // Function to get CSRF token from multiple sources
        function getCSRFToken() {
            // First try window.csrfToken
            if (window.csrfToken) {
                return window.csrfToken;
            }
            
            // Try to get from hidden input
            let tokenInput = document.querySelector('[name=csrfmiddlewaretoken]');
            if (tokenInput) {
                return tokenInput.value;
            }
            
            // Try from data attribute
            let csrfData = document.getElementById('csrf-data');
            if (csrfData) {
                return csrfData.dataset.csrf;
            }
            
            // Try from cookies as last resort
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, 10) === 'csrftoken=') {
                        cookieValue = decodeURIComponent(cookie.substring(10));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // Global AJAX setup for all requests
        document.addEventListener('DOMContentLoaded', function() {
            // Set up fetch interceptor for CSRF
            const originalFetch = window.fetch;
            window.fetch = function(url, options = {}) {
                // Only add CSRF for same-origin requests
                if (!url.startsWith('http') || url.startsWith(window.location.origin)) {
                    options.headers = options.headers || {};
                    
                    // Add CSRF token if it's a POST, PUT, PATCH, or DELETE request
                    if (['POST', 'PUT', 'PATCH', 'DELETE'].includes((options.method || 'GET').toUpperCase())) {
                        const csrfToken = getCSRFToken();
                        if (csrfToken) {
                            options.headers['X-CSRFToken'] = csrfToken;
                        }
                    }
                    
                    // Always include credentials for same-origin requests
                    options.credentials = options.credentials || 'same-origin';
                }
                
                return originalFetch(url, options);
            };
            
            // jQuery setup if available
            if (typeof $ !== 'undefined') {
                $.ajaxSetup({
                    beforeSend: function(xhr, settings) {
                        // Only add CSRF for same-origin requests
                        if (!this.crossDomain) {
                            const csrfToken = getCSRFToken();
                            if (csrfToken) {
                                xhr.setRequestHeader("X-CSRFToken", csrfToken);
                            }
                        }
                    }
                });
            }
        });
        </script>

        <!-- Hidden CSRF token fallback -->
        {% csrf_token %}
        <div id="csrf-data" data-csrf="{{ csrf_token }}" style="display: none;"></div>
</body>
</html>

