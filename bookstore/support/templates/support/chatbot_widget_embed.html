{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support Chatbot</title>
    <style>
        /* Include the CSS from the HTML artifact above */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f5f5;
            padding: 20px;
        }

        .chatbot-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            overflow: hidden;
            height: 600px;
            display: flex;
            flex-direction: column;
        }

        /* ... rest of the CSS from the HTML artifact ... */
        
    </style>
</head>
<body>
    <div class="chatbot-container">
        <div class="chatbot-header">
            <h2>ðŸ’¬ Support Assistant</h2>
            <p>I'm here to help you with your questions and support needs</p>
        </div>
        
        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be added here dynamically -->
        </div>
        
        <div class="chat-input">
            <div class="input-container">
                <input type="text" id="messageInput" placeholder="Type your message here..." onkeypress="handleKeyPress(event)">
                <button class="send-btn" id="sendBtn" onclick="sendMessage()">Send</button>
            </div>
        </div>
    </div>

    <script>
        // Add CSRF token for Django
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        
        class SupportChatbot {
            constructor() {
                this.messagesContainer = document.getElementById('chatMessages');
                this.messageInput = document.getElementById('messageInput');
                this.sendBtn = document.getElementById('sendBtn');
                this.isWaitingForResponse = false;
                this.awaitingTicketInfo = null;
                
                this.init();
            }
            
            init() {
                this.addBotMessage({
                    message: "Hi! I'm your support assistant. I can help you with common questions, search our FAQ, or create support tickets. How can I help you today?",
                    type: 'text',
                    suggestions: ['Check Order Status', 'Technical Issue', 'Refund Request', 'View FAQ']
                });
            }
            
            async sendMessage() {
                if (this.isWaitingForResponse) return;
                
                const message = this.messageInput.value.trim();
                if (!message) return;
                
                this.addUserMessage(message);
                this.messageInput.value = '';
                this.setLoading(true);
                
                try {
                    const response = await fetch('{% url "support:chatbot" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({ message: message })
                    });
                    
                    const data = await response.json();
                    
                    if (data.response) {
                        setTimeout(() => {
                            this.addBotMessage(data.response);
                            this.setLoading(false);
                        }, 1000);
                    } else {
                        this.addBotMessage({
                            message: "Sorry, I encountered an error. Please try again.",
                            type: 'text'
                        });
                        this.setLoading(false);
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.addBotMessage({
                        message: "Sorry, I'm having trouble connecting. Please try again later.",
                        type: 'text'
                    });
                    this.setLoading(false);
                }
            }
            
            // ... rest of the JavaScript from the HTML artifact ...
            
            async submitTicket() {
                const subject = document.getElementById('ticketSubject').value.trim();
                const description = document.getElementById('ticketDescription').value.trim();
                
                if (!subject || !description) {
                    alert('Please fill in both subject and description.');
                    return;
                }
                
                try {
                    const response = await fetch('{% url "support:chatbot_create_ticket" %}', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token }}'
                        },
                        body: JSON.stringify({
                            category_id: this.awaitingTicketInfo.categoryId,
                            subject: subject,
                            description: description
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        this.addBotMessage({
                            message: data.message,
                            type: 'text',
                            suggestions: ['View My Tickets', 'Ask Another Question']
                        });
                    } else {
                        this.addBotMessage({
                            message: data.message || 'Failed to create ticket. Please try again.',
                            type: 'text'
                        });
                    }
                } catch (error) {
                    this.addBotMessage({
                        message: 'There was an error creating your ticket. Please try again later.',
                        type: 'text'
                    });
                }
                
                this.awaitingTicketInfo = null;
            }
        }
        
        // Initialize chatbot
        const chatbot = new SupportChatbot();
        
        // Handle Enter key press
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                chatbot.sendMessage();
            }
        }
        
        function sendMessage() {
            chatbot.sendMessage();
        }
    </script>
    {% csrf_token %}
</body>
</html>
"""


# Chatbot Widget for embedding in other pages
# Create: support/templates/support/chatbot_widget_embed.html
"""
<!-- Floating Chatbot Widget -->
<div id="chatbot-widget" style="
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 1000;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
">
    <!-- Chat Button -->
    <div id="chat-button" style="
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        transition: transform 0.3s ease;
        color: white;
        font-size: 24px;
    " onclick="toggleChatWidget()">
        ðŸ’¬
    </div>
    
    <!-- Chat Window -->
    <div id="chat-window" style="
        position: absolute;
        bottom: 80px;
        right: 0;
        width: 350px;
        height: 500px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        overflow: hidden;
    ">
        <!-- Header -->
        <div style="
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: between;
            align-items: center;
        ">
            <div>
                <h4 style="margin: 0;">Support Assistant</h4>
                <small style="opacity: 0.9;">We're here to help!</small>
            </div>
            <button onclick="toggleChatWidget()" style="
                background: none;
                border: none;
                color: white;
                font-size: 18px;
                cursor: pointer;
                padding: 5px;
            ">Ã—</button>
        </div>
        
        <!-- Messages -->
        <div id="widget-messages" style="
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        ">
        </div>
        
        <!-- Input -->
        <div style="
            padding: 15px;
            border-top: 1px solid #eee;
        ">
            <div style="display: flex; gap: 8px;">
                <input type="text" id="widget-input" placeholder="Type a message..." style="
                    flex: 1;
                    padding: 10px;
                    border: 1px solid #ddd;
                    border-radius: 20px;
                    outline: none;
                " onkeypress="handleWidgetKeyPress(event)">
                <button onclick="sendWidgetMessage()" style="
                    background: #667eea;
                    color: white;
                    border: none;
                    padding: 10px 15px;
                    border-radius: 50%;
                    cursor: pointer;
                ">âž¤</button>
            </div>
        </div>
    </div>
</div>

<script>
let widgetChatbot = null;

function toggleChatWidget() {
    const chatWindow = document.getElementById('chat-window');
    const chatButton = document.getElementById('chat-button');
    
    if (chatWindow.style.display === 'none' || !chatWindow.style.display) {
        chatWindow.style.display = 'flex';
        chatButton.style.transform = 'scale(0.9)';
        
        if (!widgetChatbot) {
            initializeWidgetChatbot();
        }
    } else {
        chatWindow.style.display = 'none';
        chatButton.style.transform = 'scale(1)';
    }
}

function initializeWidgetChatbot() {
    const messagesContainer = document.getElementById('widget-messages');
    
    // Add initial message
    addWidgetMessage('bot', "Hi! I'm here to help. What can I assist you with?");
    
    widgetChatbot = true;
}

function addWidgetMessage(sender, message) {
    const messagesContainer = document.getElementById('widget-messages');
    const messageDiv = document.createElement('div');
    
    messageDiv.style.cssText = `
        max-width: 80%;
        padding: 8px 12px;
        border-radius: 15px;
        word-wrap: break-word;
        font-size: 14px;
        ${sender === 'user' ? 
            'align-self: flex-end; background: #667eea; color: white; margin-left: auto;' : 
            'align-self: flex-start; background: #f1f3f4; color: #333;'
        }
    `;
    
    messageDiv.textContent = message;
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function sendWidgetMessage() {
    const input = document.getElementById('widget-input');
    const message = input.value.trim();
    
    if (!message) return;
    
    addWidgetMessage('user', message);
    input.value = '';
    
    // Simulate bot response (replace with actual API call)
    setTimeout(() => {
        addWidgetMessage('bot', "I understand you need help with: " + message + ". Let me connect you with our support team.");
    }, 1000);
}

function handleWidgetKeyPress(event) {
    if (event.key === 'Enter') {
        sendWidgetMessage();
    }
}
</script>
"""
